name: Build
on:
  push:
  pull_request:
    types: [opened, synchronize, reopened]
  release:
    types: [published]

env:
  curl_options: '-f -O -L --connect-timeout 15 -m 900 --retry 15 --retry-delay 10 --retry-max-time 300 --retry-all-errors'
  make_jobs: '4'
  gmp_version: '6.3.0'
  m4_version: '1.4.19'

jobs:
  build:
    name: Build
    runs-on: windows-11-arm
    steps:
      - name: ls
        shell: bash
        run: |
          ls -la /
          uname -a
          gcc -v

      - name: dir
        shell: cmd
        run: dir c:\

      - name: Set prefix path
        shell: bash
        run: echo "prefix_path=/c/strawberry_msvc" >> $GITHUB_ENV

      - name: Create prefix path
        shell: bash
        run: mkdir -p ${{env.prefix_path}}

      - name: Create directories
        shell: bash
        run: mkdir -p ${{env.prefix_path}}/{bin,lib,include}

      - name: Create downloads directory
        shell: bash
        run: mkdir downloads

      - name: Create build directory
        shell: bash
        run: mkdir build


      - name: Download m4
        shell: bash
        working-directory: downloads
        run: curl ${{env.curl_options}} https://ftp.gnu.org/gnu/m4/m4-${{env.m4_version}}.tar.gz

      - name: Extract m4
        shell: bash
        working-directory: build
        run: tar -xf ../downloads/m4-${{env.m4_version}}.tar.gz

      - name: Configure m4
        shell: bash
        working-directory: build/m4-${{env.m4_version}}
        run: |
          #autoreconf -vfi
          ./configure --host="$(gcc -dumpmachine | sed 's|-msys$|-cygwin|')" --prefix=/c/strawberry_msvc --with-syscmd-shell=/usr/bin/sh --disable-nls --sysconfdir=/etc --localstatedir=/var --enable-threads CC=gcc

      - name: file Makefile
        shell: bash
        working-directory: build/m4-${{env.m4_version}}
        run: sed -n '213,213'p

      - name: file Makefile
        shell: bash
        working-directory: build/m4-${{env.m4_version}}
        run: dos2unix Makefile

      - name: Build m4
        shell: bash
        working-directory: build/m4-${{env.m4_version}}
        run: make -j ${{env.make_jobs}}

      - name: Install m4
        shell: bash
        working-directory: build/m4-${{env.m4_version}}
        run: make install


      - name: Download gmp
        shell: bash
        working-directory: downloads
        #run: curl ${{env.curl_options}} https://gmplib.org/download/gmp/gmp-${{env.gmp_version}}.tar.xz
        run: curl ${{env.curl_options}} https://files.jkvinge.net/packages/strawberry-dependencies/gmp-${{env.gmp_version}}.tar.xz

      - name: Extract gmp
        shell: bash
        working-directory: build
        run: tar -xf ../downloads/gmp-${{env.gmp_version}}.tar.xz

      - name: Configure gmp
        shell: bash
        working-directory: build/gmp-${{env.gmp_version}}
        run: ./configure --prefix="${{env.prefix_path}}" --disable-static --enable-shared -enable-cxx --without-readline

      - name: Build gmp
        shell: bash
        working-directory: build/gmp-${{env.gmp_version}}
        run: make -j ${{env.make_jobs}}

      - name: Install gmp
        shell: bash
        working-directory: build/gmp-${{env.gmp_version}}
        run: make install
